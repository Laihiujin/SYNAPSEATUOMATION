# 任务取消功能 - 前端使用指南

## 功能概述

任务管理页面现已支持**取消任务**和**强制取消任务**功能，可以停止待处理或正在运行的任务。

---

## 功能说明

### 1. 批量取消任务

当选中一个或多个任务后，会出现以下按钮：

#### 🟠 取消任务 (普通模式)
- **颜色**: 橙色
- **图标**: Ban (禁止图标)
- **适用状态**: `pending`（待处理）、`retry`（重试）
- **行为**: 将任务标记为已取消
- **确认提示**: "确定取消选中的 X 个任务吗？注意：running状态的任务需要使用'强制取消'"

#### 🔴 强制取消 (强制模式)
- **颜色**: 红色
- **图标**: Ban (禁止图标)
- **适用状态**: `pending`、`retry`、`running`（运行中）
- **行为**: 强制终止任务，包括正在运行的任务
- **确认提示**: "⚠️ 确定强制取消选中的 X 个任务吗？这将取消包括正在运行(running)状态的任务！"

**使用步骤**：
1. 在任务列表中勾选需要取消的任务
2. 点击顶部的"取消任务"或"强制取消"按钮
3. 确认操作
4. 等待操作完成，会显示成功/失败的消息

---

### 2. 单个任务取消

每个任务行的右侧"操作"列都有取消按钮：

#### 🟠 待处理/定时任务
- **状态**: `pending` 或 `scheduled`
- **按钮颜色**: 橙色图标
- **行为**: 普通取消（force=false）
- **确认提示**: "确定取消此任务吗？"

#### 🔴 运行中任务
- **状态**: `running`
- **按钮颜色**: 红色图标
- **行为**: 强制取消（force=true）
- **确认提示**: "⚠️ 确定强制取消正在运行的任务吗？"

**使用步骤**：
1. 在任务列表中找到需要取消的任务
2. 点击该行最右侧的取消按钮（Ban图标）
3. 确认操作
4. 任务状态会自动更新

---

## 界面布局

### 顶部操作栏

```
┌─────────────────────────────────────────────────────────────────┐
│ 任务中心                                            [操作按钮区] │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 当选中任务时显示：                                               │
│   🟠 取消任务 (X)   🔴 强制取消 (X)   🔵 重试选中 (X)   🗑️ 删除选中 (X) │
│                                                                  │
│ 未选中任务时显示：                                               │
│   🟡 清理待处理   🔴 清理失败   🟢 清理成功   🔄 刷新数据        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 任务列表

```
┌───┬──────┬────┬────┬────┬──────┬──────┬──────┐
│ ☑ │ 标题 │平台│账号│素材│ 时间 │ 状态 │ 操作 │
├───┼──────┼────┼────┼────┼──────┼──────┼──────┤
│ ☑ │ xxx  │抖音│xxx │xxx │ xxx  │待处理│  🟠  │← 普通取消
│ ☑ │ xxx  │快手│xxx │xxx │ xxx  │定时  │  🟠  │← 普通取消
│ ☐ │ xxx  │B站 │xxx │xxx │ xxx  │运行中│  🔴  │← 强制取消
│ ☐ │ xxx  │小红│xxx │xxx │ xxx  │成功  │      │← 无操作
│ ☐ │ xxx  │视频│xxx │xxx │ xxx  │失败  │      │← 无操作
└───┴──────┴────┴────┴────┴──────┴──────┴──────┘
```

---

## 使用场景

### 场景1: 取消误创建的待处理任务

**步骤**:
1. 在任务列表中找到误创建的任务（状态: 待处理）
2. 点击该任务行右侧的 🟠 取消按钮
3. 确认取消
4. 任务状态变更为"已取消"

### 场景2: 批量取消定时任务

**步骤**:
1. 勾选多个定时任务
2. 点击顶部的 🟠 "取消任务 (X)" 按钮
3. 确认操作
4. 所有选中的任务被取消

### 场景3: 强制终止卡住的运行任务

**步骤**:
1. 发现某个任务状态为"运行中"但长时间无响应
2. 点击该任务行右侧的 🔴 取消按钮
3. 在警告提示中确认强制取消
4. 任务被强制终止，状态变更为"失败"（错误信息: Force cancelled by user）

### 场景4: 批量清理卡住的任务

**步骤**:
1. 勾选多个卡住的running状态任务
2. 点击顶部的 🔴 "强制取消 (X)" 按钮
3. 在警告提示中确认批量强制取消
4. 所有选中的running任务被强制终止

---

## 技术细节

### API调用

#### 单个任务取消
```
POST /api/v1/tasks/cancel/{task_id}?force={true|false}
```

**参数**:
- `task_id`: 任务ID
- `force`: 布尔值
  - `false`: 仅取消 pending/retry 任务
  - `true`: 可取消 pending/retry/running 任务

**响应**:
```json
{
  "success": true,
  "message": "任务已取消 (force=false)"
}
```

#### 批量取消
```
POST /api/v1/tasks/batch/cancel?force={true|false}
Content-Type: application/json

{
  "task_ids": ["task_1", "task_2", "task_3"]
}
```

**响应**:
```json
{
  "success": true,
  "message": "批量取消完成 (force=true): 成功 3 个，失败 0 个",
  "success_count": 3,
  "failed_count": 0,
  "errors": null
}
```

### 状态变更

| 原始状态 | force=false | force=true |
|----------|-------------|------------|
| pending  | ✅ cancelled | ✅ failed |
| retry    | ✅ cancelled | ✅ failed |
| running  | ❌ 无法取消   | ✅ failed |
| success  | ❌ 无法取消   | ❌ 无法取消 |
| failed   | ❌ 无法取消   | ❌ 无法取消 |

**注意**:
- `force=false` 时，任务状态变为 `cancelled`
- `force=true` 时，任务状态变为 `failed`（带错误信息 "Force cancelled by user"）

---

## 按钮样式

### 批量操作按钮

```tsx
// 普通取消
<Button
  variant="outline"
  className="rounded-2xl border-orange-500/50 bg-orange-500/10 text-orange-200 hover:bg-orange-500/20"
>
  <Ban className="h-4 w-4 mr-2" />
  取消任务 (X)
</Button>

// 强制取消
<Button
  variant="outline"
  className="rounded-2xl border-red-500/50 bg-red-500/10 text-red-200 hover:bg-red-500/20"
>
  <Ban className="h-4 w-4 mr-2" />
  强制取消 (X)
</Button>
```

### 单个任务操作按钮

```tsx
// pending/scheduled 任务
<Button variant="ghost" size="sm" title="取消任务">
  <Ban className="h-4 w-4 text-orange-400" />
</Button>

// running 任务
<Button variant="ghost" size="sm" title="强制取消运行中的任务">
  <Ban className="h-4 w-4 text-red-400" />
</Button>
```

---

## 错误处理

### 常见错误

**1. 任务不存在**
```
错误提示: "无法取消任务（任务可能已完成或不存在）"
原因: 任务ID不存在或已被删除
解决: 刷新页面后重试
```

**2. 任务已完成**
```
错误提示: "无法取消任务（任务可能已完成或不存在）"
原因: 任务状态为 success 或 failed
解决: 这些任务无法取消，只能删除
```

**3. 批量取消部分失败**
```
成功提示: "批量取消完成 (force=true): 成功 5 个，失败 2 个"
原因: 部分任务无法取消（可能已完成）
查看: 查看详细错误信息了解失败原因
```

---

## 最佳实践

### 1. 选择合适的取消模式

- **普通取消**: 用于待处理的任务（pending、retry、scheduled）
- **强制取消**: 仅用于确实卡住的running任务

### 2. 谨慎使用强制取消

强制取消会立即终止任务，可能导致：
- 数据不一致
- 资源未正确释放
- 浏览器会话残留

**建议**: 只对确认卡住超过5分钟的任务使用强制取消

### 3. 批量操作前确认

批量操作前建议：
1. 检查选中的任务状态
2. 确认不会误删重要任务
3. 对于大批量操作，先取消再删除

### 4. 定期清理

建议每周执行：
```bash
# 清理卡住的running任务（服务端维护脚本）
python scripts/maintenance/cleanup_stuck_tasks.py --max-age 6
```

---

## 快捷操作

### 键盘快捷键（规划中）

| 快捷键 | 功能 |
|--------|------|
| Ctrl+A | 全选当前页任务 |
| Delete | 删除选中任务 |
| Ctrl+C | 取消选中任务 |
| Ctrl+Shift+C | 强制取消选中任务 |

---

## 相关文档

- 后端实现: `docs/TASK_TERMINATION_FIX_REPORT.md`
- API文档: 查看 `/api/v1/tasks` 路由
- 维护脚本: `scripts/maintenance/cleanup_stuck_tasks.py`

---

**最后更新**: 2025-12-19
**版本**: v1.0
