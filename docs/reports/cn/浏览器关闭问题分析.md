# æŠ–éŸ³æµè§ˆå™¨è¢«å…³é—­é—®é¢˜ - åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜æ ¹æº

### 1. äº‹ä»¶å¾ªç¯åµŒå¥—å¯¼è‡´Playwrightæ¸…ç†å†²çª
**ä½ç½®**: `task_manager.py:335-351`

å½“å‰æ¶æ„ï¼š
```
å¤–å±‚: asyncio.new_event_loop()
  â†“
  loop.run_until_complete(douyin_upload.upload())
  â†“
  loop.close()  # âš ï¸ ç«‹å³å…³é—­ï¼Œå¯èƒ½æ‰“æ–­Playwrightæ¸…ç†

å†…å±‚: async with async_playwright()
  â†“
  browser.launch() / browser.close()
```

**é—®é¢˜**: `loop.close()` ä¼šç«‹å³é”€æ¯äº‹ä»¶å¾ªç¯ï¼Œå¯¼è‡´ï¼š
- Playwright çš„å¼‚æ­¥æ¸…ç†é€»è¾‘è¢«ä¸­æ–­
- æµè§ˆå™¨è¿›ç¨‹å¯èƒ½æ®‹ç•™
- ä¸‹æ¬¡å¯åŠ¨æ—¶å‡ºç°"ä¸¤ä¸ªæµè§ˆå™¨"ç°è±¡

### 2. æœªä½¿ç”¨ try-finally ç¡®ä¿èµ„æºæ¸…ç†

**ä½ç½®**: `platforms/douyin/upload.py:167-282`

å½“å‰é€»è¾‘ï¼š
```python
try:
    async with async_playwright() as playwright:
        browser = await playwright.chromium.launch(...)
        # ä¸šåŠ¡é€»è¾‘...
        await browser.close()  # æ­£å¸¸æµç¨‹å…³é—­
        return {"success": True}
except Exception as e:
    # å¼‚å¸¸æ—¶å°è¯•å…³é—­
    if 'browser' in locals():
        await browser.close()
```

**é—®é¢˜**:
- å¦‚æœåœ¨ `async_playwright()` ä¸Šä¸‹æ–‡ç®¡ç†å™¨**å†…éƒ¨**æŠ›å‡ºå¼‚å¸¸ï¼ˆä¾‹å¦‚ç½‘ç»œè¶…æ—¶ã€DOMå®šä½å¤±è´¥ï¼‰ï¼Œ`browser` å˜é‡å¯èƒ½æœªå®šä¹‰
- `context.storage_state()` å¤±è´¥æ—¶ï¼Œæµè§ˆå™¨ä»ç„¶æ‰“å¼€

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä¼˜åŒ–äº‹ä»¶å¾ªç¯ç®¡ç†ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `task_manager.py` çš„äº‹ä»¶å¾ªç¯å…³é—­é€»è¾‘ï¼š

```python
# å½“å‰ä»£ç  (task_manager.py:335-351)
loop = asyncio.new_event_loop()
asyncio.set_event_loop(loop)
try:
    result = loop.run_until_complete(
        douyin_upload.upload(...)
    )
finally:
    loop.close()  # âš ï¸ æ”¹ä¸º: loop.run_until_complete(loop.shutdown_asyncgens())

# ä¿®å¤å:
loop = asyncio.new_event_loop()
asyncio.set_event_loop(loop)
try:
    result = loop.run_until_complete(
        douyin_upload.upload(...)
    )
finally:
    # ç¡®ä¿æ‰€æœ‰å¼‚æ­¥ç”Ÿæˆå™¨å’ŒPlaywrightæ¸…ç†å®Œæˆ
    loop.run_until_complete(loop.shutdown_asyncgens())
    loop.close()
```

**ä¼˜ç‚¹**: ç¡®ä¿ Playwright çš„æ¸…ç†é€»è¾‘æ‰§è¡Œå®Œæ¯•å†å…³é—­å¾ªç¯

### æ–¹æ¡ˆB: æ”¹ç”¨ç‹¬ç«‹Playwrightè¿›ç¨‹ï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

å‚è€ƒ `CLAUDE.md` çš„æ¶æ„è®¾è®¡ï¼Œå°† Playwright ç§»åˆ°ç‹¬ç«‹ Worker è¿›ç¨‹ï¼š

```
FastAPI API Server (task_manager.py)
  |
  | HTTP è¯·æ±‚
  â†“
Playwright Worker (ç‹¬ç«‹è¿›ç¨‹ï¼Œé•¿ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¾ªç¯)
  â†“
  ç®¡ç†æ‰€æœ‰æµè§ˆå™¨å®ä¾‹ï¼Œé¿å…å¾ªç¯å†²çª
```

**ä¼˜ç‚¹**:
- å®Œå…¨è§£è€¦äº‹ä»¶å¾ªç¯
- æ”¯æŒæµè§ˆå™¨å®ä¾‹å¤ç”¨
- æå‡ç¨³å®šæ€§

### æ–¹æ¡ˆC: ä¿®å¤ upload.py çš„èµ„æºç®¡ç†

åœ¨ `platforms/douyin/upload.py` ä¸­ä½¿ç”¨æ›´å¥å£®çš„æ¸…ç†é€»è¾‘ï¼š

```python
async def upload(...):
    browser = None
    context = None
    try:
        async with async_playwright() as playwright:
            browser = await playwright.chromium.launch(...)
            context = await browser.new_context(...)
            page = await context.new_page()

            # ä¸šåŠ¡é€»è¾‘...

            # ä¿å­˜Cookie
            await context.storage_state(path=account_file)
            await browser.close()
            browser = None  # æ ‡è®°å·²å…³é—­

            return {"success": True, ...}
    except Exception as e:
        logger.error(f"[DouyinUpload] ä¸Šä¼ å¤±è´¥: {e}")
        raise  # é‡æ–°æŠ›å‡ºï¼Œè®©è°ƒç”¨æ–¹å¤„ç†
    finally:
        # ç¡®ä¿æµè§ˆå™¨è¢«å…³é—­ï¼ˆæ— è®ºä½•ç§å¼‚å¸¸ï¼‰
        if browser is not None:
            try:
                await browser.close()
            except Exception:
                pass
```

## å½“å‰å·²å®Œæˆçš„ä¿®å¤

1. âœ… æ·»åŠ äº†å¼‚å¸¸å¤„ç†ä¸­çš„æµè§ˆå™¨å…³é—­ (`upload.py:273-278`)
2. âœ… ä¿®å¤äº†å°é¢æŒ‰é’®é€‰æ‹©é€»è¾‘ï¼ˆæ¨ªç«–å±é€‚é…ï¼‰
3. âœ… æ·»åŠ äº†è°ƒè¯•dumpåŠŸèƒ½

## å¾…å®Œæˆä¿®å¤

1. âš ï¸ **æ–¹æ¡ˆAï¼ˆå¿«é€Ÿä¿®å¤ï¼‰**: ä¿®æ”¹ `task_manager.py` çš„äº‹ä»¶å¾ªç¯æ¸…ç†é€»è¾‘
2. âš ï¸ **æ–¹æ¡ˆCï¼ˆç¨³å®šæ€§æå‡ï¼‰**: ä½¿ç”¨ finally å—ç¡®ä¿æµè§ˆå™¨å…³é—­
3. ğŸ“‹ **æ–¹æ¡ˆBï¼ˆé•¿æœŸæ¶æ„ï¼‰**: è¿ç§»åˆ°ç‹¬ç«‹Playwright Workerè¿›ç¨‹

## æµ‹è¯•å»ºè®®

ä¿®å¤åï¼Œå»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š
1. æ­£å¸¸å‘å¸ƒï¼ˆæ¨ªå±/ç«–å±è§†é¢‘ï¼‰
2. ç½‘ç»œè¶…æ—¶åœºæ™¯
3. å°é¢è®¾ç½®å¤±è´¥åœºæ™¯
4. å¤šä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œ
5. å¿«é€Ÿé‡å¤å‘å¸ƒï¼ˆæ£€æŸ¥æµè§ˆå™¨æ®‹ç•™ï¼‰

## å½±å“èŒƒå›´

- æŠ–éŸ³ (douyin)
- å¿«æ‰‹ (kuaishou)
- å°çº¢ä¹¦ (xiaohongshu)
- è§†é¢‘å· (tencent)
- Bç«™ (bilibili)

**æ‰€æœ‰å¹³å°éƒ½ä½¿ç”¨ç›¸åŒçš„æ¶æ„ï¼Œéœ€è¦ç»Ÿä¸€ä¿®å¤ã€‚**
