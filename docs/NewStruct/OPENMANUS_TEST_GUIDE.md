# OpenManus 发布功能测试指南

## 更新日期：2025-12-03

---

## 📋 概述

本测试套件用于验证 OpenManus Agent 的视频发布功能，包括：
- **单一发布**：发布单个视频到单个平台/账号
- **矩阵发布**：批量发布多个视频到多个平台/多个账号

---

## ✅ 已修复的问题

在开始测试前，请注意以下问题已在本次会话中修复：

### 1. 视频号上传按钮问题 ✅
**问题**：视频号发布时找不到上传视频的 button

**修复**：已在 `syn_backend/uploader/tencent_uploader/main.py` 添加 2024 年最新选择器：
```python
upload_button_selectors = [
    'div.upload-content',              # 2024最新：视频号上传区域
    'span.weui-icon-outlined-add',     # 2024最新：上传图标
    'div.upload-content div.center',   # 上传中心区域
    # ... 更多降级选择器
]
```

**状态**：✅ 已完成

---

### 2. 抖音 AI 标题填错位置问题 ✅
**问题**：抖音的 AI 标题会填错到描述字段内，无法正确填入标题字段

**修复**：已在 `syn_backend/platforms/douyin/upload.py` 更新标题选择器：
```python
title_selectors = [
    # 用户提供的完整 XPath（最优先）
    "/html/body/div[@id='root']/div[@class='container-box']/...",

    # 简化 XPath
    "//div[@class='editor-kit-root-container']//div[@class='container-sGoJ9f']//input[@class='semi-input semi-input-default']",

    # 降级选择器
    # ...
]
```

**状态**：✅ 已完成

---

## 🚀 测试前准备

### 1. 启动后端服务

```bash
cd D:\SynapseAutomation\syn_backend

# 激活虚拟环境
venv\Scripts\activate

# 启动 FastAPI 后端（端口 8000）
uvicorn fastapi_app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 验证后端运行

在另一个终端窗口：
```bash
curl http://localhost:8000/api/v1/tasks/health
```

应该返回：
```json
{"status": "ok"}
```

### 3. 准备测试数据

确保系统中有：
- ✅ 至少 3-5 个视频素材（在素材库中）
- ✅ 至少 2-3 个有效账号（抖音、快手等平台）
- ✅ OpenManus 配置已设置（AI 模型配置）

### 4. 检查配置

**方式 1：通过数据库**
```bash
sqlite3 D:\SynapseAutomation\syn_backend\db\database.db
SELECT * FROM ai_model_configs WHERE service_type = 'function_calling' AND is_active = 1;
```

**方式 2：通过 API**
```bash
curl http://localhost:8000/api/v1/ai/models
```

---

## 🧪 运行测试

### 方式 1：交互式测试套件（推荐）

```bash
cd D:\SynapseAutomation\syn_backend

# 激活虚拟环境
venv\Scripts\activate

# 运行测试套件
python run_openmanus_tests.py
```

这将显示交互式菜单：
```
============================================================
OpenManus Agent 发布功能测试套件
============================================================

请选择要运行的测试:

单一发布测试:
  1. 简化单一发布测试 (推荐)
  2. 完整单一发布测试

矩阵发布测试:
  3. 基础矩阵发布测试
  4. 完整矩阵发布测试
  5. 矩阵发布 + 执行测试

  0. 退出
============================================================
```

### 方式 2：直接运行单个测试

**单一发布测试**：
```bash
# 简化版
python examples/test_openmanus_single_publish.py simple

# 完整版
python examples/test_openmanus_single_publish.py
```

**矩阵发布测试**：
```bash
# 基础测试
python examples/test_openmanus_matrix_publish.py

# 完整测试
python examples/test_openmanus_matrix_publish.py full

# 发布 + 执行
python examples/test_openmanus_matrix_publish.py exec
```

---

## 📊 测试场景说明

### 单一发布测试

#### 场景 1：简化单一发布（推荐新手）
- 列出前 5 个可用素材
- 列出抖音平台的有效账号
- 将第一个素材发布到第一个账号
- 使用预定义的标题和描述

**预期结果**：
- ✅ 成功获取素材列表
- ✅ 成功获取账号列表
- ✅ 成功调用发布 API
- ✅ 任务已创建并进入队列

#### 场景 2：AI 生成内容发布
- 选择一个素材
- 根据文件名 AI 生成标题、描述、标签
- 使用生成的内容发布到小红书

**预期结果**：
- ✅ AI 生成符合平台特点的内容
- ✅ 标题符合小红书 20 字限制
- ✅ 内容包含相关话题标签

---

### 矩阵发布测试

#### 场景 3：基础矩阵发布
- 选择 2 个素材
- 发布到抖音和快手平台
- 使用所有可用账号

**预期结果**：
- ✅ 生成矩阵任务（素材数 × 平台数 × 账号数）
- ✅ 返回批次 ID
- ✅ 显示各平台任务分布

#### 场景 4：完整矩阵发布
- 选择 3 个素材
- 发布到 3-5 个平台
- 包含资源统计、任务生成、状态查看

**预期结果**：
- ✅ 完整的准备阶段报告
- ✅ 矩阵任务成功生成
- ✅ 详细的任务分布统计
- ✅ 平台适配器正确格式化内容

#### 场景 5：矩阵发布 + 执行
- 生成小规模矩阵任务
- 查看任务状态
- 实际执行一个任务进行验证

**预期结果**：
- ✅ 任务生成成功
- ✅ 状态查询正确
- ✅ 任务执行成功（或失败并记录原因）

---

## 🔍 预期输出示例

### 成功的单一发布
```
✅ 成功: True
📝 结果:
已成功将视频发布到抖音平台！

执行步骤：
1. 获取素材列表 - 找到 108 个素材
2. 获取抖音账号 - 找到 3 个有效账号
3. 调用发布 API - 任务ID: task_12345
4. 创建发布任务 - 状态: pending

📊 执行了 4 个步骤
```

### 成功的矩阵发布
```
✅ 矩阵任务已生成成功！

**批次信息**：
- 批次 ID: batch_abc123
- 批次名称: manus_matrix_1701234567

**任务统计**：
- 总任务数: 18
- 平台数: 3
- 账号数: 6
- 素材数: 3

**平台分布**：
  - douyin: 3 个账号 × 3 素材 = 9 任务
  - kuaishou: 2 个账号 × 3 素材 = 6 任务
  - xiaohongshu: 1 个账号 × 3 素材 = 3 任务
```

---

## 🐛 常见问题排查

### 问题 1：后端连接失败
**错误**：`API 调用失败 (Connection refused)`

**解决**：
1. 检查后端是否运行：`curl http://localhost:8000/api/v1/tasks/health`
2. 确认端口是否正确（默认 8000）
3. 检查防火墙设置

---

### 问题 2：OpenManus 初始化失败
**错误**：`OpenManus Agent 初始化失败: No API key configured`

**解决**：
1. 检查数据库配置：
   ```sql
   SELECT * FROM ai_model_configs WHERE service_type = 'function_calling';
   ```
2. 确保有一条记录 `is_active = 1`
3. 验证 `api_key` 不为空
4. 或手动配置 `OpenManus-worker/config/config.toml`

---

### 问题 3：没有可用素材
**错误**：`没有找到可用的素材`

**解决**：
1. 上传视频到素材库
2. 检查素材状态：
   ```bash
   curl http://localhost:8000/api/v1/files/videos
   ```

---

### 问题 4：没有可用账号
**错误**：`没有找到可用的账号`

**解决**：
1. 添加平台账号（通过前端或 API）
2. 确保账号状态为 `valid`
3. 检查账号列表：
   ```bash
   curl http://localhost:8000/api/v1/accounts/
   ```

---

### 问题 5：视频号上传仍然失败
**症状**：日志显示 `未找到文件上传元素`

**解决**：
1. 确认已应用最新修复（检查 `tencent_uploader/main.py` 第 227-240 行）
2. 检查浏览器版本（建议使用 Chrome 最新版）
3. 查看截图调试文件：`logs/channels_no_file_input.png`
4. 如仍有问题，提供截图和 HTML 结构

---

### 问题 6：抖音标题仍填错位置
**症状**：标题内容出现在描述字段

**解决**：
1. 确认已应用最新修复（检查 `douyin/upload.py` 标题选择器）
2. 运行测试验证：
   ```bash
   python examples/upload_video_to_douyin.py
   ```
3. 检查抖音页面是否改版（对比 HTML 结构）

---

## 📈 性能基准

### 单一发布
- 准备阶段：1-2 秒
- API 调用：<1 秒
- 总耗时：2-3 秒

### 矩阵发布（10 任务）
- 资源查询：2-3 秒
- 任务生成：1-2 秒
- 总耗时：3-5 秒

### 任务执行
- 抖音上传：30-60 秒/视频
- 快手上传：20-40 秒/视频
- 小红书上传：40-80 秒/视频
- B站上传：60-120 秒/视频
- 视频号上传：30-60 秒/视频

---

## 🔄 平台适配验证

测试时请验证内容格式是否符合各平台要求：

### 抖音 (代码 3)
- ✅ 标题字段：30 字以内
- ✅ 简介字段：标签合并，使用 `#标签` 格式

### 快手 (代码 4)
- ✅ 描述字段：标题 + 描述 + 标签全部合并
- ✅ 使用双换行分隔

### 小红书 (代码 1)
- ✅ 标题字段：20 字以内
- ✅ 笔记正文：描述 + 标签合并

### B站 (代码 5)
- ✅ 标题、简介、标签三个独立字段
- ✅ 标签最多 12 个

### 视频号 (代码 2)
- ✅ 只有描述字段（无独立标题）
- ✅ 标签合并到描述

---

## 📝 测试清单

运行测试时请检查以下项目：

### 测试前
- [ ] 后端服务已启动（端口 8000）
- [ ] 至少有 3 个视频素材
- [ ] 至少有 2 个有效账号
- [ ] OpenManus 配置已设置
- [ ] 虚拟环境已激活

### 单一发布测试
- [ ] 能成功获取素材列表
- [ ] 能成功获取账号列表
- [ ] 能成功调用发布 API
- [ ] 任务已创建并进入队列
- [ ] 标题和描述正确填入对应字段

### 矩阵发布测试
- [ ] 能成功生成矩阵任务
- [ ] 返回正确的批次 ID
- [ ] 任务数量计算正确
- [ ] 各平台任务分布合理
- [ ] 能查询任务状态
- [ ] 能执行任务（如测试执行）

### 平台适配测试
- [ ] 抖音：标题正确填入标题字段（非描述）
- [ ] 快手：内容正确合并
- [ ] 小红书：标题符合 20 字限制
- [ ] B站：标签正确分离
- [ ] 视频号：能找到上传按钮并成功上传

---

## 🎯 成功标准

### 基本成功
- ✅ 所有 API 调用成功（200 状态码）
- ✅ 任务成功创建并进入队列
- ✅ 无 Python 异常或错误

### 功能成功
- ✅ 单一发布能正确发布到指定平台和账号
- ✅ 矩阵发布能批量生成任务
- ✅ 任务状态查询返回正确数据
- ✅ 任务执行能正常调用上传器

### 内容成功
- ✅ 标题和描述格式符合平台要求
- ✅ 标签正确处理（合并或分离）
- ✅ 字数限制正确应用
- ✅ 特殊平台（如视频号）能正确上传

---

## 📞 获取帮助

如遇到问题，请提供以下信息：

1. **测试场景**：运行的是哪个测试（1-5）
2. **错误信息**：完整的错误堆栈
3. **系统状态**：
   - 后端是否运行
   - 素材数量
   - 账号数量和平台
4. **日志文件**：
   - 后端日志
   - OpenManus Agent 日志
5. **截图**（如适用）：
   - 错误界面
   - 浏览器控制台

---

**测试状态**：✅ 就绪
**最后更新**：2025-12-03
**维护者**：Claude Code Assistant
